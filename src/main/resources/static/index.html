<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 250px; background: #2c3e50; color: white; padding: 20px; }
        .main { flex: 1; display: flex; flex-direction: column; }
        .new-chat-btn { width: 100%; padding: 12px; background: #3498db; border: none; color: white; cursor: pointer; border-radius: 5px; margin-bottom: 20px; }
        .new-chat-btn:hover { background: #2980b9; }
        .session-list { overflow-y: auto; }
        .session-item { padding: 10px; margin-bottom: 8px; background: #34495e; border-radius: 5px; cursor: pointer; word-break: break-all; }
        .session-item:hover { background: #415a77; }
        .session-item.active { background: #3498db; }
        .chat-header { padding: 20px; background: white; border-bottom: 1px solid #ddd; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 8px; max-width: 70%; }
        .user-message { background: #3498db; color: white; margin-left: auto; }
        .ai-message { background: white; }
        .input-area { padding: 20px; background: white; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        .input-area input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; }
        .input-area button { padding: 12px 30px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .input-area button:hover { background: #2980b9; }
        .translate-section { padding: 20px; background: white; }
        .translate-section input, .translate-section select { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; }
        .translate-section button { padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .translate-result { margin-top: 10px; padding: 10px; background: #ecf0f1; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <button class="new-chat-btn" onclick="createNewSession()">+ 新建会话</button>
            <div class="session-list" id="sessionList"></div>
        </div>
        <div class="main">
            <div class="chat-header">
                <h2>AI 聊天助手</h2>
                <small id="currentSessionId"></small>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="输入消息..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()">发送</button>
            </div>
            <div class="translate-section">
                <input type="text" id="translateText" placeholder="输入要翻译的文本">
                <select id="targetLanguage">
                    <option value="英语">英语</option>
                    <option value="日语">日语</option>
                    <option value="韩语">韩语</option>
                    <option value="法语">法语</option>
                </select>
                <button onclick="translate()">翻译</button>
                <div class="translate-result" id="translateResult"></div>
            </div>
        </div>
    </div>

    <script>
        let sessions = JSON.parse(localStorage.getItem('sessions') || '[]');
        let currentMemoryId = null;

        function generateMemoryId() {
            return new Date().getTime().toString();
        }

        function createNewSession() {
            const memoryId = generateMemoryId();
            sessions.unshift({ id: memoryId, name: `会话 ${new Date().toLocaleString()}` });
            localStorage.setItem('sessions', JSON.stringify(sessions));
            switchSession(memoryId);
            renderSessions();
        }

        function switchSession(memoryId) {
            currentMemoryId = memoryId;
            document.getElementById('currentSessionId').textContent = `当前会话: ${memoryId}`;
            document.getElementById('chatMessages').innerHTML = '';
            renderSessions();
        }

        function renderSessions() {
            const list = document.getElementById('sessionList');
            list.innerHTML = sessions.map(s => 
                `<div class="session-item ${s.id === currentMemoryId ? 'active' : ''}" onclick="switchSession('${s.id}')">${s.name}</div>`
            ).join('');
        }

        async function sendMessage() {
            if (!currentMemoryId) {
                alert('请先创建会话');
                return;
            }
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            addMessage(message, 'user-message');
            input.value = '';

            const aiMessageDiv = addMessage('', 'ai-message');
            try {
                const response = await fetch(`/ollama/chat/stream?memoryId=${currentMemoryId}&message=${encodeURIComponent(message)}`);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const text = decoder.decode(value);
                    aiMessageDiv.textContent += text;
                    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
                }
            } catch (error) {
                aiMessageDiv.textContent = '错误: ' + error.message;
            }
        }

        function addMessage(text, className) {
            const div = document.createElement('div');
            div.className = `message ${className}`;
            div.textContent = text;
            document.getElementById('chatMessages').appendChild(div);
            return div;
        }

        async function translate() {
            const text = document.getElementById('translateText').value;
            const targetLanguage = document.getElementById('targetLanguage').value;
            if (!text) return;

            try {
                const response = await fetch(`/ollama/translate?text=${encodeURIComponent(text)}&targetLanguage=${encodeURIComponent(targetLanguage)}`);
                const result = await response.text();
                document.getElementById('translateResult').textContent = result;
            } catch (error) {
                document.getElementById('translateResult').textContent = '翻译失败: ' + error.message;
            }
        }

        renderSessions();
        if (sessions.length === 0) createNewSession();
        else switchSession(sessions[0].id);
    </script>
</body>
</html>
